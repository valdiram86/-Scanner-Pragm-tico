<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Pragm√°tico</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f8f8; }
    input, select, button, textarea {
      margin: 5px; padding: 6px; font-size: 14px;
    }
    button { cursor: pointer; }
    textarea { width: 100%; height: 80px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #eee; cursor: pointer; }
    th.sortable::after { content: " ‚¨ç"; font-size: 12px; }
    tr:hover { background: #f1f1f1; }
    #topQuedas { background: #d4f7d4; padding: 10px; margin-top: 15px; border: 1px solid #bbb; }
    #totalMoedas, #busca { margin-top: 10px; }
  </style>
</head>
<body>

  <h2>Painel Cripto Pragm√°tico</h2>

  <input type="email" placeholder="Seu e-mail" />
  <select id="abaSelect">
    <option value="TopPerdedoras_1_100">TopPerdedoras 1-100</option>
    <option value="TopPerdedoras_101_200">TopPerdedoras 101-200</option>
    <option value="TopPerdedoras_201_300">TopPerdedoras 201-300</option>
    <option value="TopPerdedoras_301_400">TopPerdedoras 301-400</option>
    <option value="TopPerdedoras_401_500">TopPerdedoras 401-500</option>
    <option value="TopPerdedoras_501_750">TopPerdedoras 501-750</option>
    <option value="TopPerdedoras_751_1000">TopPerdedoras 751-1000</option>
    <option value="TopPerdedoras_1001_1250">TopPerdedoras 1001-1250</option>
    <option value="TopPerdedoras_1251_1500">TopPerdedoras 1251-1500</option>
    <option value="TopVolumePragmatico">Top Volume por Faixa</option>
  </select>
  <button onclick="carregarAba()">Carregar Aba</button>
  <button onclick="exportarCSV()">CSV</button>

  <div id="topQuedas">
    <h4>üìâ Top 10 quedas combinadas (7D + 30D) e maior volume:</h4>
    <ul id="listaTop"></ul>
  </div>

  <h4>üìù Anota√ß√µes Pessoais</h4>
  <textarea id="anotacoes"></textarea>

  <div>
    <p>Total de moedas: <span id="totalMoedas">0</span></p>
    <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrarTabela()" />
  </div>

  <table id="tabela">
    <thead><tr id="cabecalho"></tr></thead>
    <tbody></tbody>
  </table>

<script>
const URL_BASE = 'https://script.google.com/macros/s/AKfycbx5SzHPXb16HYdTVt_BMOAdcP5Dy21JbC1EiOyc4IsiQPMXV6SumyVgTreySF-3Z46rIg/exec';
let dadosAtuais = [];

window.onload = () => {
  restaurarAnotacoes();
  carregarAba(); // Carrega a primeira aba automaticamente
};

function carregarAba() {
  const aba = document.getElementById("abaSelect").value;
  fetch(`${URL_BASE}?aba=${encodeURIComponent(aba)}`)
    .then(r => r.json())
    .then(json => {
      dadosAtuais = json.dados;
      renderizarTabela(dadosAtuais);
      renderizarTopQuedas(dadosAtuais);
      document.getElementById("totalMoedas").innerText = dadosAtuais.length - 1;
    });
}

function renderizarTabela(dados) {
  const cabecalho = dados[0];
  const linhas = dados.slice(1);
  const head = document.getElementById("cabecalho");
  const body = document.querySelector("#tabela tbody");

  head.innerHTML = "";
  body.innerHTML = "";

  cabecalho.forEach((h, i) => {
    const th = document.createElement("th");
    th.textContent = h;
    th.classList.add("sortable");
    th.onclick = () => ordenarPorColuna(i);
    head.appendChild(th);
  });

  linhas.forEach(l => {
    const tr = document.createElement("tr");
    l.forEach(c => {
      const td = document.createElement("td");
      if (String(c).startsWith("http")) {
        td.innerHTML = `<a href="${c}" target="_blank">üîó Link</a>`;
      } else {
        td.textContent = c;
      }
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

function ordenarPorColuna(index) {
  const cab = dadosAtuais[0];
  const corpo = dadosAtuais.slice(1);

  const isNum = corpo.every(r => !isNaN(parseFloat(r[index])));
  corpo.sort((a, b) => {
    if (isNum) return parseFloat(b[index]) - parseFloat(a[index]);
    return String(a[index]).localeCompare(b[index]);
  });

  renderizarTabela([cab, ...corpo]);
}

function renderizarTopQuedas(dados) {
  const cab = dados[0];
  const corpo = dados.slice(1);
  const idx7 = cab.findIndex(h => /7[dD]/.test(h));
  const idx30 = cab.findIndex(h => /30[dD]/.test(h));
  const idxVol = cab.findIndex(h => /Volume/.test(h));
  const idxNome = cab.findIndex(h => /Nome|Symbol|S√≠mbolo/.test(h));

  const top = corpo.map(r => ({
    nome: r[idxNome],
    queda: (parseFloat(r[idx7]) || 0) + (parseFloat(r[idx30]) || 0),
    volume: parseFloat(r[idxVol]) || 0
  }))
  .filter(m => !isNaN(m.queda))
  .sort((a, b) => a.queda - b.queda || b.volume - a.volume)
  .slice(0, 10);

  const ul = document.getElementById("listaTop");
  ul.innerHTML = "";
  top.forEach((m, i) => {
    const li = document.createElement("li");
    li.textContent = `üìå Queda Combinada #${i + 1}: ${m.nome}`;
    ul.appendChild(li);
  });
}

function exportarCSV() {
  let csv = dadosAtuais.map(l => l.join(";")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "dados.csv";
  a.click();
}

function filtrarTabela() {
  const termo = document.getElementById("busca").value.toLowerCase();
  const linhas = document.querySelectorAll("#tabela tbody tr");
  linhas.forEach(tr => {
    const visivel = [...tr.children].some(td => td.textContent.toLowerCase().includes(termo));
    tr.style.display = visivel ? "" : "none";
  });
}

document.getElementById("anotacoes").addEventListener("input", () => {
  localStorage.setItem("anotacoes", document.getElementById("anotacoes").value);
});

function restaurarAnotacoes() {
  const texto = localStorage.getItem("anotacoes");
  if (texto) document.getElementById("anotacoes").value = texto;
}
</script>

</body>
</html>
