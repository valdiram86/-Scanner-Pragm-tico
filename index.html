<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Scanner Pragm√°tico</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1, h2 { color: #222; }
    select, table, button { margin-top: 20px; }
    table.dataTable th, table.dataTable td { white-space: nowrap; }
    .top-moedas { margin-bottom: 30px; padding: 15px; background: #fff; border-radius: 5px; }
    #btc-variacao { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    .positivo { color: green; }
    .negativo { color: red; }
  </style>
</head>
<body>

  <h1>üîç Scanner Pragm√°tico ‚Äî CoinMarketCap</h1>
  <p><a href="https://script.google.com/macros/s/AKfycbx5SzHPXb16HYdTVt_BMOAdcP5Dy21JbC1EiOyc4IsiQPMXV6SumyVgTreySF-3Z46rIg/exec" target="_blank">Ver dados brutos</a></p>

  <div id="btc-variacao">Carregando varia√ß√£o do BTC...</div>

  <div class="top-moedas">
    <h2>üî• Top 1 por faixa</h2>
    <ul id="listaTop10"></ul>
  </div>

  <label for="seletor">üìÇ Escolher faixa:</label>
  <select id="seletor">
    <option value="todas">Mostrar todas</option>
  </select>

  <button onclick="copiarTabelaComLinks()">üìã Copiar tabela com links</button>

  <table id="tabelaGlobal" class="display" style="width:100%">
    <thead><tr id="cabecalhoTabela"></tr></thead>
    <tbody></tbody>
  </table>

<script>
  const abas = [
    'TopPerdedoras_1_100', 'TopPerdedoras_101_200', 'TopPerdedoras_201_300',
    'TopPerdedoras_301_400', 'TopPerdedoras_401_500', 'TopPerdedoras_501_750',
    'TopPerdedoras_751_1000', 'TopPerdedoras_1001_1250', 'TopPerdedoras_1251_1500'
  ];

  const API_URL = 'https://script.google.com/macros/s/AKfycbx5SzHPXb16HYdTVt_BMOAdcP5Dy21JbC1EiOyc4IsiQPMXV6SumyVgTreySF-3Z46rIg/exec';
  let tabela;
  let cabecalhoGlobal = [];
  let todasMoedas = [];

  $(document).ready(async function () {
    await carregarVariacaoBTC();

    const topMoedas = [];
    $('#seletor').append(abas.map(aba => `<option value="${aba}">${aba}</option>`));

    for (const aba of abas) {
      const res = await fetch(`${API_URL}?aba=${aba}`);
      const json = await res.json();
      const valores = json.dados;

      if (valores.length < 3) continue;

      const headers = valores[1];
      if (cabecalhoGlobal.length === 0) {
        cabecalhoGlobal = headers;
        $('#cabecalhoTabela').html(headers.map(h => `<th>${h}</th>`).join(''));
      }

      const linhas = valores.slice(2).map(l => ({ aba, linha: l }));
      todasMoedas = todasMoedas.concat(linhas);

      const topMoeda = linhas[0];
      if (topMoeda && topMoeda.linha.length >= 3) {
        topMoedas.push(`<li><strong>${aba}:</strong> <a href="${topMoeda.linha[2]}" target="_blank">${topMoeda.linha[0]}</a></li>`);
      }
    }

    $('#listaTop10').html(topMoedas.join(''));

    tabela = $('#tabelaGlobal').DataTable({
      data: [],
      columns: cabecalhoGlobal.map(titulo => ({ title: titulo })),
      paging: false,
      lengthChange: false,
      order: [],
      language: {
        search: "üîé Filtrar:",
        info: "Exibindo _TOTAL_ moedas"
      },
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'csvHtml5',
          text: 'Exportar CSV',
          exportOptions: {
            format: {
              body: function (data, row, column, node) {
                return node.innerHTML || data;
              }
            }
          }
        },
        {
          extend: 'pdfHtml5',
          text: 'Exportar PDF',
          exportOptions: {
            stripHtml: false
          }
        }
      ]
    });

    atualizarTabela("todas");

    $('#seletor').on('change', function () {
      const abaEscolhida = $(this).val();
      atualizarTabela(abaEscolhida);
    });
  });

  async function carregarVariacaoBTC() {
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      const variacao = parseFloat(json.btc).toFixed(2);
      const texto = `üìà Varia√ß√£o do BTC nas √∫ltimas 24h: ${variacao}%`;

      const $el = $('#btc-variacao');
      $el.text(texto);
      $el.removeClass('positivo negativo');
      $el.addClass(variacao >= 0 ? 'positivo' : 'negativo');
    } catch (e) {
      $('#btc-variacao').text('‚ö†Ô∏è Erro ao carregar BTC');
    }
  }

  function atualizarTabela(abaSelecionada) {
    let filtradas = abaSelecionada === "todas"
      ? todasMoedas
      : todasMoedas.filter(m => m.aba === abaSelecionada);

    const dadosFinal = filtradas.map(obj => {
      return obj.linha.map(cell => {
        if (typeof cell === 'string' && cell.startsWith("http")) {
          return `<a href="${cell}" target="_blank">üîó</a>`;
        }
        return cell;
      });
    });

    tabela.clear();
    tabela.rows.add(dadosFinal);
    tabela.draw();
  }

  // ‚úÖ C√≥pia universal via sele√ß√£o + execCommand (funciona em Android)
  function copiarTabelaComLinks() {
    const tabela = document.getElementById('tabelaGlobal');
    if (!tabela) return alert('Tabela n√£o encontrada');

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = tabela.outerHTML;
    tempDiv.style.position = 'fixed';
    tempDiv.style.top = '-1000px';
    document.body.appendChild(tempDiv);

    const range = document.createRange();
    range.selectNode(tempDiv);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);

    try {
      const sucesso = document.execCommand('copy');
      if (sucesso) {
        alert('‚úÖ Tabela copiada com links! Cole no e-mail ou WhatsApp Web.');
      } else {
        alert('‚ùå N√£o foi poss√≠vel copiar. Copie manualmente.');
      }
    } catch (err) {
      alert('‚ùå Erro ao copiar: ' + err);
    }

    selection.removeAllRanges();
    document.body.removeChild(tempDiv);
  }
</script>
</body>
</html>
