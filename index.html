<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Scanner Pragmático</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1 { color: #222; }
    select, table { margin-top: 20px; }
    table.dataTable th, table.dataTable td { white-space: nowrap; }
    #btc-variacao {
      font-size: 18px;
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .positivo { color: green; }
    .negativo { color: red; }
  </style>
</head>
<body>

  <h1>🔍 Scanner Pragmático — CoinMarketCap</h1>
  <p><a href="https://script.google.com/macros/s/AKfycbx5SzHPXb16HYdTVt_BMOAdcP5Dy21JbC1EiOyc4IsiQPMXV6SumyVgTreySF-3Z46rIg/exec" target="_blank">Ver dados brutos</a></p>

  <div id="btc-variacao">Carregando variação do BTC...</div>

  <label for="seletor">📂 Escolher faixa:</label>
  <select id="seletor">
    <option value="todas">Mostrar todas</option>
  </select>

  <table id="tabelaGlobal" class="display" style="width:100%">
    <thead><tr id="cabecalhoTabela"></tr></thead>
    <tbody></tbody>
  </table>

<script>
  const abas = [
    'TopPerdedoras_1_100', 'TopPerdedoras_101_200', 'TopPerdedoras_201_300',
    'TopPerdedoras_301_400', 'TopPerdedoras_401_500', 'TopPerdedoras_501_750',
    'TopPerdedoras_751_1000', 'TopPerdedoras_1001_1250', 'TopPerdedoras_1251_1500',
    'TopVolumePragmatico'
  ];

  const API_URL = 'https://script.google.com/macros/s/AKfycbx5SzHPXb16HYdTVt_BMOAdcP5Dy21JbC1EiOyc4IsiQPMXV6SumyVgTreySF-3Z46rIg/exec';
  const BTC_API_URL = 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest?id=1';
  const CMC_API_KEY = 'c4382123-4586-4082-85b2-119603ed1ffd';

  let tabela;
  let cabecalhoGlobal = [];
  let todasMoedas = [];

  $(document).ready(async function () {
    await carregarVariacaoBTC();

    $('#seletor').append(abas.map(aba => `<option value="${aba}">${aba}</option>`));

    for (const aba of abas) {
      const res = await fetch(`${API_URL}?aba=${aba}`);
      const json = await res.json();
      const valores = json.dados;

      if (valores.length < 3) continue;

      const headers = valores[1];
      if (cabecalhoGlobal.length === 0) {
        cabecalhoGlobal = headers;
        $('#cabecalhoTabela').html(headers.map(h => `<th>${h}</th>`).join(''));
      }

      const linhas = valores.slice(2).map(l => ({ aba, linha: l }));
      todasMoedas = todasMoedas.concat(linhas);
    }

    tabela = $('#tabelaGlobal').DataTable({
      data: [],
      columns: cabecalhoGlobal.map(titulo => ({ title: titulo })),
      paging: false,
      lengthChange: false,
      order: [],
      language: {
        search: "🔎 Filtrar:",
        info: "Exibindo _TOTAL_ moedas"
      }
    });

    atualizarTabela("todas");

    $('#seletor').on('change', function () {
      const abaEscolhida = $(this).val();
      atualizarTabela(abaEscolhida);
    });
  });

  async function carregarVariacaoBTC() {
    try {
      const res = await fetch(BTC_API_URL, {
        headers: {
          'X-CMC_PRO_API_KEY': CMC_API_KEY,
          'Accept': 'application/json'
        }
      });
      const data = await res.json();
      const variacao = parseFloat(data.data["1"].quote.USD.percent_change_24h).toFixed(2);

      const texto = `📈 Variação do BTC nas últimas 24h: ${variacao}%`;
      const elemento = $('#btc-variacao');
      elemento.text(texto);
      elemento.addClass(variacao >= 0 ? 'positivo' : 'negativo');

    } catch (erro) {
      $('#btc-variacao').text('⚠️ Não foi possível carregar a variação do BTC');
    }
  }

  function atualizarTabela(abaSelecionada) {
    let filtradas = abaSelecionada === "todas"
      ? todasMoedas
      : todasMoedas.filter(m => m.aba === abaSelecionada);

    const dadosFinal = filtradas.map(obj => {
      return obj.linha.map(cell => {
        if (typeof cell === 'string' && cell.startsWith("http")) {
          return `<a href="${cell}" target="_blank">🔗</a>`;
        }
        return cell;
      });
    });

    tabela.clear();
    tabela.rows.add(dadosFinal);
    tabela.draw();
  }
</script>
</body>
</html>
