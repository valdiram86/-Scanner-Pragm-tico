<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Scanner PragmÃ¡tico</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    h1, h2 { color: #222; }
    #btc-variacao {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .positivo { color: green; }
    .negativo { color: red; }
    .top-moedas {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    table.dataTable th, table.dataTable td {
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <h1>ğŸ” Scanner PragmÃ¡tico â€” CoinMarketCap</h1>
  <div id="btc-variacao">Carregando variaÃ§Ã£o do BTC...</div>

  <div class="top-moedas">
    <h2>ğŸ”¥ Top 1 por faixa</h2>
    <ul id="listaTop10"></ul>
  </div>

  <label for="seletor">ğŸ“‚ Escolher faixa:</label>
  <select id="seletor">
    <option value="todas">Mostrar todas</option>
  </select>

  <table id="tabelaGlobal" class="display nowrap" style="width:100%">
    <thead><tr id="cabecalhoTabela"></tr></thead>
    <tbody></tbody>
  </table>

<script>
  const abas = [
    'TopPerdedoras_1_100', 'TopPerdedoras_101_200', 'TopPerdedoras_201_300',
    'TopPerdedoras_301_400', 'TopPerdedoras_401_500', 'TopPerdedoras_501_750',
    'TopPerdedoras_751_1000', 'TopPerdedoras_1001_1250', 'TopPerdedoras_1251_1500'
  ];
  const API_URL = 'https://script.google.com/macros/s/AKfycbx5SzHPXb16HYdTVt_BMOAdcP5Dy21JbC1EiOyc4IsiQPMXV6SumyVgTreySF-3Z46rIg/exec';

  let tabela;
  let cabecalhoGlobal = [];
  let todasMoedas = [];

  $(document).ready(async function () {
    await carregarVariacaoBTC();

    const topMoedas = [];
    $('#seletor').append(abas.map(aba => `<option value="${aba}">${aba}</option>`));

    for (const aba of abas) {
      const res = await fetch(`${API_URL}?aba=${aba}`);
      const json = await res.json();
      const valores = json.dados;

      if (valores.length < 3) continue;

      const headers = valores[1];
      if (cabecalhoGlobal.length === 0) {
        cabecalhoGlobal = headers;
        $('#cabecalhoTabela').html(headers.map(h => `<th>${h}</th>`).join(''));
      }

      const linhas = valores.slice(2).map(l => ({ aba, linha: l }));
      todasMoedas = todasMoedas.concat(linhas);

      const topMoeda = linhas[0];
      if (topMoeda && topMoeda.linha.length >= 3) {
        topMoedas.push(`<li><strong>${aba}:</strong> <a href="${topMoeda.linha[2]}" target="_blank">${topMoeda.linha[0]}</a></li>`);
      }
    }

    $('#listaTop10').html(topMoedas.join(''));

    tabela = $('#tabelaGlobal').DataTable({
      data: [],
      columns: cabecalhoGlobal.map(titulo => ({ title: titulo })),
      paging: false,
      order: [],
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'csvHtml5',
          text: 'â¬‡ï¸ Exportar CSV',
          className: 'btn-export'
        },
        {
          extend: 'pdfHtml5',
          text: 'ğŸ“„ Exportar PDF',
          className: 'btn-export',
          orientation: 'landscape',
          pageSize: 'A4'
        }
      ],
      language: {
        search: "ğŸ” Filtrar:",
        info: "Exibindo _TOTAL_ moedas"
      }
    });

    atualizarTabela("todas");

    $('#seletor').on('change', function () {
      const abaEscolhida = $(this).val();
      atualizarTabela(abaEscolhida);
    });
  });

  async function carregarVariacaoBTC() {
    try {
      const res = await fetch(`${API_URL}`);
      const json = await res.json();
      const variacao = parseFloat(json.btc);
      const texto = `ğŸ“ˆ VariaÃ§Ã£o do BTC nas Ãºltimas 24h: ${variacao.toFixed(2)}%`;
      const $el = $('#btc-variacao');
      $el.text(texto);
      $el.addClass(variacao >= 0 ? 'positivo' : 'negativo');
    } catch (e) {
      $('#btc-variacao').text('âš ï¸ Erro ao carregar BTC');
    }
  }

  function atualizarTabela(abaSelecionada) {
    let filtradas = abaSelecionada === "todas"
      ? todasMoedas
      : todasMoedas.filter(m => m.aba === abaSelecionada);

    const dadosFinal = filtradas.map(obj => {
      return obj.linha.map(cell => {
        if (typeof cell === 'string' && cell.startsWith("http")) {
          return `<a href="${cell}" target="_blank">ğŸ”—</a>`;
        }
        return cell;
      });
    });

    tabela.clear();
    tabela.rows.add(dadosFinal);
    tabela.draw();
  }
</script>

</body>
</html>
